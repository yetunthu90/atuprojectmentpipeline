name: Laravel CI/CD with Kubernetes

on:
  push:
    branches:
      - main
      - dev

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Tag and Push App Image
        run: |
          docker tag group_1_studio_ghibli_movie_maker-app ${{ secrets.DOCKER_USERNAME }}/atupipeline-app:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/atupipeline-app:latest

      - name: Tag and Push Web Image
        run: |
          docker tag group_1_studio_ghibli_movie_maker-web ${{ secrets.DOCKER_USERNAME }}/atupipeline-web:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/atupipeline-web:latest

      - name: Tag and Push phpMyAdmin Image
        run: |
          docker tag group_1_studio_ghibli_movie_maker-pma ${{ secrets.DOCKER_USERNAME }}/atupipeline-phpmyadmin:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/atupipeline-phpmyadmin:latest

      - name: Tag and Push Database Image
        run: |
          docker tag group_1_studio_ghibli_movie_maker-database ${{ secrets.DOCKER_USERNAME }}/atupipeline-mysqldb:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/atupipeline-mysqldb:latest

      - name: Run Tests in Docker
        run: |
          docker compose up -d --build
          docker compose exec app php artisan test
          docker compose down

#  deploy:
#    needs: build-and-test
#    runs-on: ubuntu-latest
#    if: github.ref == 'refs/heads/main'

#    steps:
#     - name: Checkout Repository
 #       uses: actions/checkout@v3

  #    - name: Set up Kubernetes CLI
   #     uses: azure/setup-kubectl@v3

    #  - name: Configure Kubeconfig
     #   run: echo "${{ secrets.KUBECONFIG }}" | base64 --decode > $HOME/.kube/config

   #   - name: Deploy to Kubernetes
   #     run: |
    #      kubectl apply -f k8s/
    #      kubectl rollout restart deployment laravel-app
    #      kubectl rollout restart deployment laravel-web
     #     kubectl rollout restart deployment phpmyadmin
     #     kubectl rollout restart deployment mysqldb
